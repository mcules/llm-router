{{ define "layout.html" }}
<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>LLM Router UI</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 24px; }
    nav a { margin-right: 12px; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border-bottom: 1px solid #ddd; padding: 8px; text-align: left; }
    .muted { color: #666; }
    .badge { display:inline-block; padding:2px 8px; border:1px solid #ddd; border-radius:999px; }
    .live-indicator { width: 10px; height: 10px; background: #ccc; border-radius: 50%; display: inline-block; margin-left: 10px; }
    .live-indicator.active { background: #2ecc71; box-shadow: 0 0 5px #2ecc71; }
  </style>
</head>
<body>
  <nav>
    <a href="/ui/">Dashboard</a>
    <a href="/ui/nodes">Nodes</a>
    <a href="/ui/models">Models</a>
    <a href="/ui/policies">Policies</a>
    <a href="/ui/keys">API Keys</a>
    <a href="/ui/users">Users</a>
    <a href="/ui/activity">Activity</a>
    <div id="live-indicator" class="live-indicator" title="Live Updates (SSE)"></div>
    {{ if .User }}
    <span style="float: right;">
        Logged in as: <strong>{{ .User.Username }}</strong>
        | <a href="#" onclick="showPasswordChangeGlobal('{{ .User.Username }}')" style="font-size: 0.9em;">Change PW</a>
        <a href="/ui/logout" style="margin-left: 10px; color: #e74c3c;">Logout</a>
    </span>
    {{ end }}
  </nav>
  <hr/>
  {{ template "page_content" . }}

  <!-- Simple Password Change Modal (Global) -->
  <div id="passwordModalGlobal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:2000;">
      <div style="background:white; width:300px; margin: 100px auto; padding:20px; border-radius:5px;">
          <h4>Change Password for <span id="pwTargetUserGlobal"></span></h4>
          <form action="/ui/users/password" method="POST">
              <input type="hidden" name="username" id="pwUsernameInputGlobal">
              <input type="password" name="password" placeholder="New Password" required style="width:100%; padding:5px; margin-bottom:10px;">
              <div style="display:flex; justify-content: space-between;">
                  <button type="button" onclick="hidePasswordChangeGlobal()">Cancel</button>
                  <button type="submit">Change</button>
              </div>
          </form>
      </div>
  </div>

  <script>
    function showPasswordChangeGlobal(user) {
        document.getElementById('pwTargetUserGlobal').innerText = user;
        document.getElementById('pwUsernameInputGlobal').value = user;
        document.getElementById('passwordModalGlobal').style.display = 'block';
    }
    function hidePasswordChangeGlobal() {
        document.getElementById('passwordModalGlobal').style.display = 'none';
    }

    const evtSource = new EventSource("/ui/events");
    const indicator = document.getElementById("live-indicator");
    evtSource.onmessage = (event) => {
        // We could update the DOM here, but for now just show activity
        indicator.classList.add("active");
        setTimeout(() => indicator.classList.remove("active"), 300);
        console.log("Snapshot update", JSON.parse(event.data));
    };
    evtSource.addEventListener("snapshot", (event) => {
        indicator.classList.add("active");
        setTimeout(() => indicator.classList.remove("active"), 300);
    });
    evtSource.onerror = (err) => {
        console.error("SSE failed:", err);
        indicator.style.background = "#e74c3c";
    };
  </script>
</body>
</html>
{{ end }}
